<?php

define('ABSPATH', false);
define( 'ELEMENTOR_VERSION', '2.1.4' );
define( 'ELEMENTOR_PREVIOUS_STABLE_VERSION', '2.0.16' );

define('ELEMENTOR__FILE__', __FILE__);
define('ELEMENTOR_PLUGIN_BASE', '');
define('ELEMENTOR_PATH', drupal_get_path('module', 'elementor') . '/elementor/');
if (defined('ELEMENTOR_TESTS') && ELEMENTOR_TESTS) {
    define('ELEMENTOR_URL', 'file://' . ELEMENTOR_PATH);
} else {
    define('ELEMENTOR_URL', '');
}
define('ELEMENTOR_MODULES_PATH', '');
define('ELEMENTOR_ASSETS_URL', '/' . ELEMENTOR_PATH . 'assets/');

require drupal_get_path('module', 'elementor') . '/wordpress_functions.php';

require drupal_get_path('module', 'elementor') . '/elementor/includes/plugin.php';

require drupal_get_path('module', 'elementor') . '/Drupal_api.php';
require drupal_get_path('module', 'elementor') . '/Drupal_Ajax_Manager.php';
require drupal_get_path('module', 'elementor') . '/DocumentDrupal.php';
require drupal_get_path('module', 'elementor') . '/ElementorDrupal.php';

use Drupal\elementor\ElementorDrupal;

/**
 * Implements hook_preprocess_field().
 */

function elementor_preprocess_field(&$variables, $hook)
{
    $element = $variables['element'];

    $allow_content_types = \Drupal::config('elementor.settings')->get('node_types');

    if ($variables['field_name'] == 'body' && in_array($element['#bundle'], $allow_content_types, true)) {
        $delta = 0;

        $node = \Drupal::routeMatch()->getParameter('node');
        if ($node) {
            $uid = $node->id();
        } else {
            $uid = 1;
        }

        $ElementorDrupal = ElementorDrupal::$instance;
        $frontend_data = $ElementorDrupal->frontend($uid);

        while (!empty($element[$delta])) {
            $variables['items'][$delta]['content'] = [
                '#theme' => 'elementor_field',
                '#base_path' => base_path(),
                '#uid' => $uid,
                '#elementor_tmp' => $frontend_data,
                '#cache' => array('max-age' => 0),
            ];
            $delta++;
        }
    }

}

/**
 * Implements hook__menu_local_tasks_alter().
 */

function elementor_menu_local_tasks_alter(&$data, $route_name)
{
    $allow_content_types = \Drupal::config('elementor.settings')->get('node_types');
    $node = \Drupal::routeMatch()->getParameter('node');
    if ($node) {
        $nid = $node->id();
    } else {
        $nid = 1;
    }
    if ($route_name == 'entity.node.canonical' &&  in_array($node->getType(), $allow_content_types, true)) {
        $data['tabs'][0]['entity.node.canonical'] = [
            '#theme' => 'menu_local_task',
            '#link' => [
                'title' => t('Elementor'),
                'url' => \Drupal\Core\Url::fromRoute('elementor.editor' , ['node' => $nid]),
                'localized_options' => [
                    'attributes' => [
                        'title' => t('Edit with Elementor'),
                    ],
                ],
            ],
        ];
    }
}

/**
 * Implements hook_theme().
 */

function elementor_theme($existing, $type, $theme, $path)
{
    return array(
        'elementor_field' => array(
            'variables' => array('elementor_data' => null, 'elementor_tmp' => null, 'base_path' => base_path()),
        ),
        'elementor_editor' => array(
            'variables' => array('elementor_data' => null),
        ),
    );
}
